# ================================
# Research Agent Crew Tasks
# Optimized for Low Token Usage
# ================================

search_listings:
  description: >
    Use Tavily Search Tool to find REAL property listing URLs that match
    the user's search criteria exactly.

    Search intent example:
    "2 bedroom house for rent in Massachusetts under $8000 monthly"

    RULES (STRICT):
    - You MUST use Tavily Search Tool
    - Query format:
      "{search_criteria} site:zillow.com OR site:realtor.com OR site:apartments.com"
    - Only return URLs that clearly represent:
      - Individual property listing pages
      - Rentals (not sales)
    - DO NOT return:
      - Search result pages
      - Blog posts
      - Category or filter pages
    - Minimum 3 URLs, Maximum 6 URLs
    - DO NOT invent or guess URLs

    OUTPUT FORMAT (CRITICAL):
    - Your output MUST be a valid JSON object with exactly two root keys: "urls" and "platforms".
    - DO NOT wrap the output in markdown code blocks (e.g., ```json ... ```). Output raw JSON only.
    - DO NOT nest the response under a "properties" key.
    - Example:
      {
        "urls": ["https://url1...", "https://url2..."],
        "platforms": ["zillow", "realtor"]
      }

    Relevance filtering:
    - Prefer listings where preview/snippet indicates:
      - Correct bedroom count (if provided)
      - Rent price within budget (if visible)
      - Correct location (city/state)

  expected_output: >
    {
      "urls": [
        "https://www.zillow.com/homedetails/...",
        "https://www.realtor.com/realestateandhomes-detail/..."
      ],
      "platforms": ["zillow", "realtor"]
    }

  agent: scraper
  tool_choice: required

extract_listings:
  description: >
    For EACH URL provided from `search_listings`, use a REAL browser
    automation session to extract rental listing data from the fully
    rendered page.

    YOU MUST use the Browser Use MCP tool `browser_task`.

    ABSOLUTE RULES (NON-NEGOTIABLE):
    - You MUST open each listing URL in a real browser via `browser_task`
    - You MUST wait for JavaScript to fully render
    - You MUST extract data ONLY from what is visibly rendered
    - You MUST NOT infer, guess, reconstruct, or reformat any values
    - If a value is not explicitly visible, return null
    - DO NOT "clean up" or rewrite tool output
    - DO NOT fabricate Zillow CDN URLs

    IMAGE EXTRACTION (CRITICAL):
    - Collect image URLs ONLY from rendered <img src> attributes
    - COPY image URLs VERBATIM exactly as observed in the browser
    - Image URLs MUST:
        - Be single-line strings
        - Contain no whitespace or line breaks
        - Match exactly what the browser returns
    - NEVER reconstruct or approximate Zillow image URLs
    - If no images are visible, return an empty array []

    FAILURE HANDLING:
    - If a page blocks loading, retry ONCE
    - If still blocked, skip the listing and record it as failed

    REQUIRED FIELDS PER LISTING:
    - listing_url (original URL, verbatim)
    - platform (zillow, realtor, apartments, etc.)
    - address (exact text as shown)
    - price (exact string as shown)
    - price_frequency (daily | weekly | monthly | yearly)
    - bedrooms
    - bathrooms
    - description (visible text only, max ~300 words)
    - images (VERBATIM image URLs only)
    - facts_and_features (only what is explicitly listed)
    - contact:
        - name
        - phone
        - email

    OUTPUT RULES (STRICT):
    - Return ONLY valid JSON
    - No markdown
    - No explanations
    - No HTML
    - No wrapped strings
    - No inferred values

  expected_output: >
    {
      "listings": [
        {
          "listing_url": "https://...",
          "platform": "zillow",
          "address": "4 Austin St #2, Somerville, MA 02145",
          "price": "$3,200",
          "price_frequency": "monthly",
          "bedrooms": 4,
          "bathrooms": 1,
          "description": "...",
          "images": [
            "https://photos.zillowstatic.com/fp/a0241d2b8f5b432d9262cdf7fbd86c2-cc_ft_960.jpg"
          ],
          "facts_and_features": {
            "sqft": 1300
          },
          "contact": {
            "name": "Property Manager",
            "phone": "617-555-1234",
            "email": "leasing@example.com"
          }
        }
      ],
      "summary": {
        "attempted": 5,
        "successful": 4,
        "failed": 1
      }
    }

  agent: extractor
  context:
    - search_listings
  tool_choice: required


validate_data:
  description: >
    Validate extracted rental listings for completeness and basic correctness.

    VALIDATION CHECKS:
    1. Mandatory:
       - address OR listing_url
       - price
       - at least one of: phone or email
    2. Logical:
       - Bedrooms and bathrooms must be positive integers if present
       - Price must be within $100 – $100,000
       - Image URLs must start with http/https
    3. Assign quality_score (0–100):
       - 90–100: Complete and clean
       - 70–89: Minor missing fields
       - 50–69: Multiple gaps
       - <50: Critical issues

    IMPORTANT:
    - Do NOT remove listings
    - Only flag issues
    - Add validation_notes per listing if needed

  expected_output: >
    {
      "listings": [
        {
          "...": "...",
          "quality_score": 92,
          "validation_notes": []
        }
      ],
      "summary": {
        "total": 4,
        "passed": 3,
        "flagged": 1
      }
    }

  agent: validator
  context:
    - extract_listings

compile_research_report:
  description: >
    Compile validated rental listings into a frontend-ready JSON report
    for human review and approval.

    REQUIREMENTS:
    - Snake_case keys
    - Stable property IDs (prop_001, prop_002, ...)
    - Sorted by quality_score DESC
    - No empty objects (use null or empty arrays)

    REPORT STRUCTURE:
    1. metadata:
       - search_criteria
       - generated_at
       - total_found
       - total_validated
    2. properties:
       - id
       - display_title
       - price_display
       - location_display
       - primary_image
       - all_images
       - specs (beds, baths, sqft, type)
       - contact
       - listing_url
       - quality_score
    3. issues:
       - properties_with_no_contact
       - properties_with_no_images
       - properties_flagged

  expected_output: >
    {
      "metadata": { ... },
      "properties": [ ... ],
      "issues": { ... }
    }

  agent: report_agent
  context:
    - validate_data
  output_file: output/research_results.json
