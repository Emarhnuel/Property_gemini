# ================================
# Research Agent Crew Tasks
# Optimized for Amazon Nova Models
# ================================

search_listings:
  description: >
    Use the tavily_search tool to find REAL rental property listing URLs
    matching the user's search criteria.

    SEARCH CRITERIA:
    {search_criteria}

    RULES:
    - You MUST call the tavily_search tool with a search query.
    - Return 3-6 individual listing URLs (not search/category pages).
    - Only include rental listings (not for sale).
    - Do NOT include zillow.com URLs.
    - Never invent or guess URLs.

    EXAMPLE TOOL CALL:
    When you use the tavily_search tool, pass the query like this:
    Action: tavily_search
    Action Input: 2 bedroom apartment for rent in Houston TX

    If no rental listings are found, return:
    {{"urls": [], "platforms": []}}

    YOUR FINAL ANSWER MUST BE ONLY THIS JSON (no other text):
    {{
      "urls": ["https://www.realtor.com/...", "https://www.apartments.com/..."],
      "platforms": ["realtor", "apartments"]
    }}

  expected_output: >
    {
      "urls": [
        "https://www.realtor.com/realestateandhomes-detail/...",
        "https://www.apartments.com/..."
      ],
      "platforms": ["realtor", "apartments"]
    }

  agent: scraper
  tool_choice: required

extract_listings:
  description: >
    For EACH URL from the search_listings task, use the crawl_extract
    tool to extract rental property data.

    RULES:
    - You MUST call crawl_extract for each URL.
    - Do NOT guess or fabricate data. Only use what the tool returns.
    - Skip listings that are "For Sale", "Sold", or "Off Market".
    - If crawl_extract fails for a URL, skip it and continue.

    EXAMPLE TOOL CALL:
    When you use the crawl_extract tool, pass the URL like this:
    Action: crawl_extract
    Action Input: {{"url": "https://www.realtor.com/realestateandhomes-detail/123-main-st"}}

    REQUIRED FIELDS PER LISTING:
    listing_url, platform, address, price, price_frequency,
    bedrooms, bathrooms, description, images, facts_and_features, contact

    YOUR FINAL ANSWER MUST BE ONLY THIS JSON (no other text):
    {{
      "listings": [
        {{
          "listing_url": "https://...",
          "platform": "realtor",
          "address": "123 Main St, City, ST",
          "price": "$2,500",
          "price_frequency": "monthly",
          "bedrooms": 2,
          "bathrooms": 2,
          "description": "Full description from the page...",
          "images": ["https://img1.jpg", "https://img2.jpg"],
          "facts_and_features": ["Central AC", "In-unit laundry"],
          "contact": {{"phone": "555-0123"}}
        }}
      ],
      "summary": {{"attempted": 5, "successful": 4, "failed": 1}}
    }}

  expected_output: >
    {
      "listings": [
        {
          "listing_url": "https://...",
          "platform": "realtor",
          "address": "123 Main St, New York, NY",
          "price": "$6,000",
          "price_frequency": "monthly",
          "bedrooms": 2,
          "bathrooms": 2,
          "description": "...",
          "images": ["https://..."],
          "facts_and_features": ["Central AC"],
          "contact": {"phone": "555-0123"}
        }
      ],
      "summary": {
        "attempted": 5,
        "successful": 4,
        "failed": 1
      }
    }

  agent: extractor
  context:
    - search_listings
  tool_choice: required

validate_data:
  description: >
    Validate extracted rental listings for completeness and correctness.

    CHECKS:
    1. Required: address OR listing_url, price, at least one contact method
    2. Logical: bedrooms/bathrooms are positive numbers, price $100-$100,000
    3. Score each listing 0-100 (90+: complete, 70-89: minor gaps, <70: issues)

    Do NOT remove listings. Only flag issues and add validation_notes.

    YOUR FINAL ANSWER MUST BE ONLY THIS JSON (no other text):
    {{
      "listings": [
        {{
          "listing_url": "https://...",
          "quality_score": 92,
          "validation_notes": []
        }}
      ],
      "summary": {{"total": 4, "passed": 3, "flagged": 1}}
    }}

  expected_output: >
    {
      "listings": [
        {
          "...": "...",
          "quality_score": 92,
          "validation_notes": []
        }
      ],
      "summary": {
        "total": 4,
        "passed": 3,
        "flagged": 1
      }
    }

  agent: validator
  context:
    - extract_listings

compile_research_report:
  description: >
    Compile validated rental listings into a frontend-ready JSON report.

    REQUIREMENTS:
    - Snake_case keys
    - Property IDs: prop_001, prop_002, etc.
    - Sorted by quality_score descending
    - No empty objects (use null or empty arrays)

    REPORT STRUCTURE:
    1. metadata: search_criteria, generated_at, total_found, total_validated
    2. properties: id, display_title, price_display, location_display,
       primary_image, all_images, specs, contact, listing_url, quality_score
    3. issues: properties_with_no_contact, properties_with_no_images, properties_flagged

    YOUR FINAL ANSWER MUST BE ONLY THIS JSON (no other text):
    {{
      "metadata": {{"search_criteria": "...", "total_found": 4}},
      "properties": [],
      "issues": {{}}
    }}

  expected_output: >
    {
      "metadata": { "..." : "..." },
      "properties": [ "..." ],
      "issues": { "..." : "..." }
    }

  agent: report_agent
  context:
    - validate_data
  output_file: output/research_results.json
