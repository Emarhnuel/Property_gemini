# ================================
# Research Agent Crew Tasks
# Optimized for Amazon Nova Models
# ================================

search_listings:
  description: >
    <task>
    Use the exa_search tool to find REAL rental property listing URLs matching the user's search criteria.
    </task>

    <search_criteria>
    {search_criteria}
    </search_criteria>

    <instructions>
    - You MUST use the exa_search tool to find the properties.
    - IMPORTANT: When using the tool, you MUST provide the search string as the 'query' argument.
    - Return 3-6 individual listing URLs (not search/category pages).
    - Only include rental listings (not for sale).
    - Do NOT include zillow.com URLs.
    - If no rental listings are found, return empty arrays.
    </instructions>

    <formatting>
    Return the output strictly as a JSON object with 'urls' and 'platforms' arrays.
    </formatting>

  expected_output: >
    {
      "urls": [
        "https://www.realtor.com/realestateandhomes-detail/...",
        "https://www.apartments.com/..."
      ],
      "platforms": ["realtor", "apartments"]
    }

  agent: scraper
  tool_choice: required

extract_listings:
  description: >
    <task>
    For EACH URL provided by the search_listings task, use the crawl_extract tool to extract rental property data.
    </task>

    <instructions>
    - You MUST use the crawl_extract tool for each URL. Give the tool the URL to extract data from.
    - IMPORTANT: When using the tool, you MUST provide the target URL as the 'url' argument.
    - Do NOT guess or fabricate data. Only use the data returned by the tool.
    - Skip listings that are "For Sale", "Sold", or "Off Market".
    - If the tool fails for a URL, skip it and continue.
    - Required fields per listing: listing_url, platform, address, price, price_frequency, bedrooms, bathrooms, description, images, facts_and_features, contact.
    </instructions>

    <formatting>
    Return the output strictly as a JSON object containing a 'listings' array and a 'summary' object.
    </formatting>

  expected_output: >
    {
      "listings": [
        {
          "listing_url": "https://...",
          "platform": "realtor",
          "address": "123 Main St, New York, NY",
          "price": "$6,000",
          "price_frequency": "monthly",
          "bedrooms": 2,
          "bathrooms": 2,
          "description": "...",
          "images": ["https://..."],
          "facts_and_features": ["Central AC"],
          "contact": {"phone": "555-0123"}
        }
      ],
      "summary": {
        "attempted": 5,
        "successful": 4,
        "failed": 1
      }
    }

  agent: extractor
  context:
    - search_listings
  tool_choice: required

validate_data:
  description: >
    <task>
    Validate extracted rental listings for completeness and correctness.
    </task>

    <instructions>
    - Check Required Fields: address OR listing_url, price, at least one contact method.
    - Check Logic: bedrooms/bathrooms must be positive numbers, price between $100 and $100,000.
    - Score each listing 0-100 (90+: complete, 70-89: minor gaps, <70: issues).
    - Do NOT remove listings. Only flag issues and add validation_notes.
    </instructions>

    <formatting>
    Return the output strictly as a JSON object containing the evaluated 'listings' and a 'summary'.
    </formatting>

  expected_output: >
    {
      "listings": [
        {
          "...": "...",
          "quality_score": 92,
          "validation_notes": []
        }
      ],
      "summary": {
        "total": 4,
        "passed": 3,
        "flagged": 1
      }
    }

  agent: validator
  context:
    - extract_listings

compile_research_report:
  description: >
    <task>
    Compile validated rental listings into a frontend-ready JSON report.
    </task>

    <instructions>
    - Use snake_case for all JSON keys.
    - Generate unique Property IDs: prop_001, prop_002, etc.
    - Sort the list by quality_score in descending order.
    - Remove any empty objects (use null or empty arrays instead).
    - Include metadata: search_criteria, generated_at, total_found, total_validated.
    - Map properties to include: id, display_title, price_display, location_display, primary_image, all_images, specs, contact, listing_url, quality_score.
    - List issues: properties_with_no_contact, properties_with_no_images, properties_flagged.
    </instructions>

    <formatting>
    Return the output strictly as a JSON object with 'metadata', 'properties', and 'issues' keys.
    </formatting>

  expected_output: >
    {
      "metadata": { "..." : "..." },
      "properties": [ "..." ],
      "issues": { "..." : "..." }
    }

  agent: report_agent
  context:
    - validate_data
  output_file: output/research_results.json
