# ================================
# Research Agent Crew Tasks
# Optimized for Low Token Usage
# ================================

search_listings:
  description: >
    Use Tavily Search Tool to find REAL property listing URLs that match
    the user's search criteria exactly.

    Search intent example:
    "2 bedroom house for rent in Massachusetts under $8000 monthly"

    RULES (STRICT):
    - You MUST use Tavily Search Tool
    - Query format:
      "{search_criteria} site:zillow.com OR site:realtor.com OR site:apartments.com"
    - Only return URLs that clearly represent:
      - Individual property listing pages
      - Rentals (not sales)
    - DO NOT return:
      - Search result pages
      - Blog posts
      - Category or filter pages
    - Minimum 3 URLs, Maximum 6 URLs
    - DO NOT invent or guess URLs

    OUTPUT FORMAT (CRITICAL):
    - Your output MUST be a valid JSON object with exactly two root keys: "urls" and "platforms".
    - DO NOT wrap the output in markdown code blocks (e.g., ```json ... ```). Output raw JSON only.
    - DO NOT nest the response under a "properties" key.
    - Example:
      {
        "urls": ["https://url1...", "https://url2..."],
        "platforms": ["zillow", "realtor"]
      }

    Relevance filtering:
    - Prefer listings where preview/snippet indicates:
      - Correct bedroom count (if provided)
      - Rent price within budget (if visible)
      - Correct location (city/state)

  expected_output: >
    {
      "urls": [
        "https://www.zillow.com/homedetails/...",
        "https://www.realtor.com/realestateandhomes-detail/..."
      ],
      "platforms": ["zillow", "realtor"]
    }

  agent: scraper
  tool_choice: required

extract_listings:
  description: >
    For EACH URL provided from `search_listings`, use a REAL BROWSER
    automation tool to open the listing page and extract rendered rental data.

    You MUST use the `browser_task` MCP tool.

    BROWSER INSTRUCTIONS (STRICT):
    - Open the listing URL in a real browser
    - Wait for JavaScript to fully load
    - Scroll the page if needed to reveal content
    - Extract ONLY rendered content (not raw HTML)
    - If the page is blocked, retry once before skipping
    - Do NOT use API-based scraping tools
    - Do NOT infer or fabricate missing values

    REQUIRED FIELDS PER LISTING:
    - listing_url (original URL)
    - platform (zillow, realtor, apartments, etc.)
    - address (full address if available)
    - price (numeric or string as shown)
    - price_frequency (daily | weekly | monthly | yearly)
    - bedrooms
    - bathrooms
    - description (trimmed, max ~300 words)
    - images (ALL image URLs found on the page)
    - facts_and_features (parking, pets, sqft, year built, etc.)
    - contact:
        - name
        - phone
        - email

    IMAGE RULES:
    - Return image URLs only
    - No base64
    - Empty array if none found

    OUTPUT RULES:
    - Return ONLY clean structured JSON
    - No raw HTML
    - No markdown
    - No explanations

  expected_output: >
    {
      "listings": [
        {
          "listing_url": "https://...",
          "platform": "zillow",
          "address": "123 Main St, New York, NY",
          "price": "$6,000",
          "price_frequency": "monthly",
          "bedrooms": 2,
          "bathrooms": 2,
          "description": "...",
          "images": [
            "https://photos.zillowstatic.com/..."
          ],
          "facts_and_features": {
            "sqft": 1200,
            "pets": "Allowed"
          },
          "contact": {
            "name": "John Doe",
            "phone": "212-555-1234",
            "email": "agent@example.com"
          }
        }
      ],
      "summary": {
        "attempted": 5,
        "successful": 4,
        "failed": 1
      }
    }

  agent: extractor
  context:
    - search_listings
  tool_choice: required

validate_data:
  description: >
    Validate extracted rental listings for completeness and basic correctness.

    VALIDATION CHECKS:
    1. Mandatory:
       - address OR listing_url
       - price
       - at least one of: phone or email
    2. Logical:
       - Bedrooms and bathrooms must be positive integers if present
       - Price must be within $100 – $100,000
       - Image URLs must start with http/https
    3. Assign quality_score (0–100):
       - 90–100: Complete and clean
       - 70–89: Minor missing fields
       - 50–69: Multiple gaps
       - <50: Critical issues

    IMPORTANT:
    - Do NOT remove listings
    - Only flag issues
    - Add validation_notes per listing if needed

  expected_output: >
    {
      "listings": [
        {
          "...": "...",
          "quality_score": 92,
          "validation_notes": []
        }
      ],
      "summary": {
        "total": 4,
        "passed": 3,
        "flagged": 1
      }
    }

  agent: validator
  context:
    - extract_listings

compile_research_report:
  description: >
    Compile validated rental listings into a frontend-ready JSON report
    for human review and approval.

    REQUIREMENTS:
    - Snake_case keys
    - Stable property IDs (prop_001, prop_002, ...)
    - Sorted by quality_score DESC
    - No empty objects (use null or empty arrays)

    REPORT STRUCTURE:
    1. metadata:
       - search_criteria
       - generated_at
       - total_found
       - total_validated
    2. properties:
       - id
       - display_title
       - price_display
       - location_display
       - primary_image
       - all_images
       - specs (beds, baths, sqft, type)
       - contact
       - listing_url
       - quality_score
    3. issues:
       - properties_with_no_contact
       - properties_with_no_images
       - properties_flagged

  expected_output: >
    {
      "metadata": { ... },
      "properties": [ ... ],
      "issues": { ... }
    }

  agent: report_agent
  context:
    - validate_data
  output_file: output/research_results.json
