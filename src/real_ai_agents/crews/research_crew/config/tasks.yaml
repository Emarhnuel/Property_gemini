# ================================
# Research Agent Crew Tasks
# Optimized for Amazon Nova Models
# ================================

search_listings:
  description: >
    Your task is to find REAL rental property listing URLs matching the following search criteria:
    {search_criteria}
    
    CRITICAL: You MUST use the exa_search tool to gather these URLs. Provide the search string as the 'query' argument to your tool. Do NOT guess or fabricate URLs.
    
    - Return 3 to 6 individual listing URLs (not overarching search or category pages).
    - Only include rental listings (do not include properties for sale).
    - Exclude zillow.com URLs.
    - If no rental listings are found, return empty arrays.
    - You must output real links obtained directly from your search tool.
  expected_output: >
    A JSON object containing exactly two keys: 'urls' (a list of string URLs) and 'platforms' (a list of string names of the platforms where the URLs were found). For example:
    {
      "urls": [
        "https://www.realtor.com/realestateandhomes-detail/...",
        "https://www.apartments.com/..."
      ],
      "platforms": ["realtor", "apartments"]
    }
  agent: scraper

extract_listings:
  description: >
    For EACH URL provided by the previous search_listings task, use your crawl_extract tool to extract the property data.
    
    CRITICAL: You MUST use the crawl_extract tool. Provide the target URL as the 'url' argument to the tool.
    
    - Extract the following fields for each listing: listing_url, platform, address, price, price_frequency, bedrooms, bathrooms, description, images, facts_and_features, contact.
    - Skip listings that are "For Sale", "Sold", or "Off Market".
    - Do NOT guess or fabricate data. Only use the data successfully returned by the extraction tool.
    - If the tool fails for a URL, simply skip it and proceed to the next one.
  expected_output: >
    A JSON object containing a 'listings' array (where each item has the extracted property details) and a 'summary' object (containing 'attempted', 'successful', and 'failed' counts).
  agent: extractor
  context:
    - search_listings

validate_data:
  description: >
    Review the structured property data extracted in the extract_listings task and validate it for completeness and correctness.
    
    - Check Required Fields: Ensure each listing has an address OR listing_url, a price, and at least one contact method.
    - Check Logic: Bedrooms and bathrooms must be positive numbers. Price must be between $100 and $100,000.
    - Action: Score each listing from 0 to 100 (90+: complete, 70-89: minor gaps, <70: major issues).
    - Add clear explanations for any deductions in the validation_notes array.
    - Do NOT remove any listings. Just flag any issues found.
  expected_output: >
    A JSON object containing the evaluated 'listings' (each property with its added 'quality_score' and 'validation_notes' fields) and a 'summary' object ('total', 'passed', 'flagged').
  agent: validator
  context:
    - extract_listings

compile_research_report:
  description: >
    Compile the validated rental listings into a frontend-ready JSON report.
    
    - Format all JSON keys in snake_case.
    - Add a unique ID to each property (e.g., prop_001, prop_002).
    - Sort the properties by quality_score in descending order.
    - Replace any empty objects with null or empty arrays.
    - Include a 'metadata' block: search_criteria, generated_at, total_found, total_validated.
    - Include an 'issues' block: properties_with_no_contact, properties_with_no_images, properties_flagged.
    - Property mapping must include: id, display_title, price_display, location_display, primary_image, all_images, specs, contact, listing_url, quality_score.
  expected_output: >
    A strictly formatted JSON object with three root keys: 'metadata', 'properties', and 'issues'.
  agent: report_agent
  context:
    - validate_data
  output_file: output/research_results.json
