# ================================
# Research Agent Crew Tasks
# Optimized for Low Token Usage
# ================================

search_listings:
  description: >
    Use the Tavily Search tool to find REAL, individual rental property
    listing URLs that match the user's search criteria exactly.

    USER SEARCH CRITERIA (USE THIS):
    {search_criteria}

    TOOL USAGE (MANDATORY):
    - You MUST use the Tavily Search tool.
    - Construct a natural search query based on the user's criteria.
    - DO NOT search on zillow.com (blocked).

    URL SELECTION RULES (STRICT):
    - Return ONLY URLs that point to individual rental listing pages.
    - Listings MUST be rentals (not sales).
    - DO NOT return:
        - Search result pages
        - Category pages
        - Blog posts
        - Market reports
        - Aggregation pages
    - Minimum: 3 URLs
    - Maximum: 6 URLs
    - NEVER invent, guess, or modify URLs.

    RENTAL-ONLY FILTER (MANDATORY):
    - ONLY include URLs for properties explicitly marked "For Rent"
    - EXCLUDE any property that is:
        - For Sale
        - Sold
        - Pending
        - Off Market
        - Under Contract
    - If unsure whether a listing is for rent, SKIP it.

    OUTPUT FORMAT (ABSOLUTE):
    - Your FINAL answer MUST contain ONLY a valid JSON object.
    - The JSON MUST have EXACTLY two root keys: "urls" and "platforms".
    - Do NOT include any text, explanations, comments, or instructions.
    - Do NOT wrap the JSON in markdown code blocks.
    - Do NOT repeat task instructions.
    - Do NOT include trailing characters before or after the JSON.

    JSON SCHEMA (STRICT):
    {
      "urls": ["https://..."],
      "platforms": ["realtor", "apartments", "trulia", "rent", "hotpads"]
    }

    PLATFORM RULES:
    - "platforms" must only include platforms that appear in "urls".
    - BLOCKED: zillow.com (do NOT include).
    - Allowed: realtor, apartments, trulia, rent, hotpads, or other legitimate rental sites.
    - No duplicates.

  expected_output: >
    {
      "urls": [
        "https://www.realtor.com/realestateandhomes-detail/...",
        "https://www.apartments.com/..."
      ],
      "platforms": ["realtor", "apartments"]
    }

  agent: scraper
  tool_choice: required

extract_listings:
  description: >
    CRAWL EXTRACTION TASK — Use the `crawl_extract` tool.

    For EACH URL provided from `search_listings`, you MUST use the
    `crawl_extract` tool to open the page in a REAL local browser.

    ❌ You are NOT allowed to extract data by reasoning, guessing,
    prior knowledge, memory, or API-based scraping.
    ❌ You are NOT allowed to infer missing values.
    ❌ If you do not use `crawl_extract`, your output will be rejected.

    EXECUTION REQUIREMENTS (MANDATORY):
    - Call `crawl_extract` with each URL
    - The tool will handle browser rendering and extraction
    - Extract ONLY what the tool returns

    SELF-CHECK (IMPORTANT):
    - Before producing your final answer, confirm you used `crawl_extract`
    - If you did NOT, STOP and use it


    RENTAL FILTER (STRICT):
    - ONLY extract listings explicitly marked "For Rent"
    - SKIP listings marked "For Sale", "Sold", "Pending", "Off Market"
    - Price MUST indicate rental frequency (e.g. $/mo, $/week)

    REQUIRED FIELDS PER LISTING:
    - listing_url
    - platform
    - address
    - price
    - price_frequency
    - bedrooms
    - bathrooms
    - description (verbatim, rendered text)
    - images (ALL rendered image URLs)
    - facts_and_features
    - contact (name, phone, or email)

    BROWSER OUTPUT SIGNALS (REALISTIC):
    - At least 2 image URLs per listing
    - Description must be 30+ words
    - facts_and_features must contain 2+ entries

    OUTPUT RULES:
    - Return ONLY valid JSON
    - No markdown
    - No explanations
    - No raw HTML

  expected_output: >
    {
      "listings": [
        {
          "listing_url": "https://...",
          "platform": "realtor",
          "address": "123 Main St, New York, NY",
          "price": "$6,000",
          "price_frequency": "monthly",
          "bedrooms": 2,
          "bathrooms": 2,
          "description": "...",
          "images": ["https://..."],
          "facts_and_features": {},
          "contact": {}
        }
      ],
      "summary": {
        "attempted": 5,
        "successful": 4,
        "failed": 1
      }
    }

  agent: extractor
  context:
    - search_listings
  tool_choice: required

validate_data:
  description: >
    Validate extracted rental listings for completeness and basic correctness.

    VALIDATION CHECKS:
    1. Mandatory:
       - address OR listing_url
       - price
       - at least one of: phone or email
    2. Logical:
       - Bedrooms and bathrooms must be positive integers if present
       - Price must be within $100 – $100,000
       - Image URLs must start with http/https
    3. Assign quality_score (0–100):
       - 90–100: Complete and clean
       - 70–89: Minor missing fields
       - 50–69: Multiple gaps
       - <50: Critical issues

    IMPORTANT:
    - Do NOT remove listings
    - Only flag issues
    - Add validation_notes per listing if needed

  expected_output: >
    {
      "listings": [
        {
          "...": "...",
          "quality_score": 92,
          "validation_notes": []
        }
      ],
      "summary": {
        "total": 4,
        "passed": 3,
        "flagged": 1
      }
    }

  agent: validator
  context:
    - extract_listings

compile_research_report:
  description: >
    Compile validated rental listings into a frontend-ready JSON report
    for human review and approval.

    REQUIREMENTS:
    - Snake_case keys
    - Stable property IDs (prop_001, prop_002, ...)
    - Sorted by quality_score DESC
    - No empty objects (use null or empty arrays)

    REPORT STRUCTURE:
    1. metadata:
       - search_criteria
       - generated_at
       - total_found
       - total_validated
    2. properties:
       - id
       - display_title
       - price_display
       - location_display
       - primary_image
       - all_images
       - specs (beds, baths, sqft, type)
       - contact
       - listing_url
       - quality_score
    3. issues:
       - properties_with_no_contact
       - properties_with_no_images
       - properties_flagged

  expected_output: >
    {
      "metadata": { ... },
      "properties": [ ... ],
      "issues": { ... }
    }

  agent: report_agent
  context:
    - validate_data
  output_file: output/research_results.json
